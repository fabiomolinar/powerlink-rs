# Orchestrates the MN and CN containers for integration testing.
services:
  cn:
    container_name: powerlink-cn
    build:
      context: ../../../.. # Workspace root relative to this file
      dockerfile: ./crates/powerlink-io-linux/tests/loopback_test_resources/Dockerfile
    environment:
      POWERLINK_TEST_ROLE: "CN" # Role for the test binary
      POWERLINK_CN_NODE_ID: "42" # Define the CN Node ID here
      RUST_LOG: debug # Enable debug logging
      RUST_BACKTRACE: 1 # Provide backtraces on panic
    networks:
      powerlink_net:
        ipv4_address: 192.168.100.42 # Assign static IP based on Node ID
    cap_add:
      - NET_RAW # Allow opening raw sockets
    depends_on: # Ensure MN starts first (optional but good practice)
      - mn
    # Command override to pass test flags and the specific test filter:
    command: ["--ignored", "--nocapture", "${POWERLINK_TEST_TO_RUN}", "--"]

  mn:
    container_name: powerlink-mn
    build:
      context: ../../../.. # Workspace root relative to this file
      dockerfile: ./crates/powerlink-io-linux/tests/loopback_test_resources/Dockerfile
    environment:
      POWERLINK_TEST_ROLE: "MN" # Role for the test binary
      POWERLINK_CN_NODE_ID: "42" # Pass CN Node ID to MN as well
      RUST_LOG: debug # Enable debug logging
      RUST_BACKTRACE: 1 # Provide backtraces on panic
    networks:
      powerlink_net:
        ipv4_address: 192.168.100.240 # Assign static IP for MN
    cap_add:
      - NET_RAW # Allow opening raw sockets
    # Command override to pass test flags and the specific test filter:
    command: ["--ignored", "--nocapture", "${POWERLINK_TEST_TO_RUN}", "--"]


networks:
  powerlink_net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 192.168.100.0/24 # Define the POWERLINK standard subnet
